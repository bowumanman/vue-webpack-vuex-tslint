/**
 * logline v1.0.6 (https://github.com/latel/logline#readme)
 * Copyright 2017, latel <latelx64@icloud.com>
 * MIT license
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Logline=e()}(this,function(){"use strict";function t(t){throw new Error("Logline: "+t)}function e(t,e,o,r){s&&window.console[l[e.toUpperCase()]||l.INFO]("%c %s %s %c %s. "+("object"===("undefined"==typeof r?"undefined":n(r))?"%O":"%s"),f[e.toUpperCase()]||f.INFO,e,t,"color:initial",o,r||"")}function o(t){var e,r={};if("object"!==("undefined"==typeof t?"undefined":n(t)))return t;for(e in t)t.hasOwnProperty(e)&&"function"!=typeof t[e]&&(r[e]=o(t[e]));return r}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}(),i=function t(e,o,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,o);if(void 0===r){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,o,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},c=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},u=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},s=window.console,l={INFO:"log",WARN:"warn",ERROR:"error",CRITICAL:"error"},f={INFO:"color:#FFF;background:gray",WARN:"color:#FFF;background:orange",ERROR:"color:#FFF;background:red",CRITICAL:"color:#FFF;background:black"},p=function(){function e(t){r(this,e),this._namespace=t}return a(e,[{key:"_record",value:function(e,o,n){t("method _record is not implemented.")}},{key:"info",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["info"].concat(e))}},{key:"warn",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["warn"].concat(e))}},{key:"error",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["error"].concat(e))}},{key:"critical",value:function(){for(var t=arguments.length,e=Array(t),o=0;o<t;o++)e[o]=arguments[o];this._record.apply(this,["critical"].concat(e))}}],[{key:"init",value:function(t){return!0}},{key:"transTimeFormat",value:function(t,e){if(!t||/^\d{13}$/.test(t))return+t;if(e&&!/^\d{13}$/.test(e))throw new TypeError("relative time should be standard unix timestamp");return(e||Date.now())-24*t.replace(/d$/,"")*3600*1e3}},{key:"get",value:function(e,o,n){t("method get is not implemented.")}},{key:"keep",value:function(e){t("method keep is not implemented.")}},{key:"clean",value:function(){t("method clean is not implemented.")}},{key:"STATUS",get:function(){return{INITING:1,INITED:2,FAILED:4}}}]),e}(),d=function(){function t(){r(this,t),this._pool=[]}return a(t,[{key:"push",value:function(t,e){t.context=e,this._pool.push(t)}},{key:"consume",value:function(){for(var t;t=this._pool.shift();)t.call(t.context)}}]),t}(),_=function(n){function s(){var t;r(this,s);for(var e=arguments.length,o=Array(e),n=0;n<e;n++)o[n]=arguments[n];return u(this,(t=s.__proto__||Object.getPrototypeOf(s)).call.apply(t,[this].concat(o)))}return c(s,n),a(s,[{key:"_record",value:function(n,r,a){var i=this;if(s.status!==p.STATUS.INITED)return s._pool.push(function(){return i._record(n,r,a)}),void(s.status!==p.STATUS.INITING&&s.init());e(this._namespace,n,r,a);var c=s.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");c.onerror=function(e){return t(e.target.error)};var u=c.objectStore("logs"),l=u.add({time:Date.now(),level:n,namespace:this._namespace,descriptor:r,data:o(a)});l.onerror=function(e){s.status=p.STATUS.FAILED,t(e.target.error)}}}],[{key:"init",value:function(e){var o=this;return s.support||t("your platform does not support indexeddb protocol."),!s.status&&(s._pool=s._pool||new d,s._database=e||"logline",s.status=i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITING,s.request=window.indexedDB.open(s._database),s.request.onerror=function(e){return t("protocol indexeddb is prevented.")},s.request.onsuccess=function(e){s.db=e.target.result,s.status=i(s.__proto__||Object.getPrototypeOf(s),"STATUS",o).INITED,s._pool.consume(),s.db.onerror=function(e){return t(e.target.error)}},void(s.request.onupgradeneeded=function(t){var e=t.target.result,o=e.createObjectStore("logs",{autoIncrement:!0});o.createIndex("namespace","namespace",{unique:!1}),o.createIndex("level","level",{unique:!1}),o.createIndex("descriptor","descriptor",{unique:!1}),o.createIndex("data","data",{unique:!1})}))}},{key:"get",value:function(e,o,n){if(s.status!==i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return s._pool.push(function(){return s.get(e,o,n)});e=p.transTimeFormat(e),o=p.transTimeFormat(o);var r=s._getTransactionStore(IDBTransaction.READ_ONLY||"readonly"),a=r.openCursor(),c=[];a.onsuccess=function(t){var r=t.target.result;r?((e&&r.value.time<e||o&&r.value.time>o)&&r.continue(),c.push({time:r.value.time,level:r.value.level,namespace:r.value.namespace,descriptor:r.value.descriptor,data:r.value.data}),r.continue()):n(c)},a.onerror=function(e){return t("failed to literat on logs from database.")}}},{key:"keep",value:function(e){if(s.status!==i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return s._pool.push(function(){return s.keep(e)});var o=s._getTransactionStore(IDBTransaction.READ_WRITE);if(e)!function(){var n=Date.now()-24*(e||2)*3600*1e3,r=o.openCursor();r.onsuccess=function(t){var e=t.target.result;e&&e.value.time<n&&(o.delete(e.primaryKey),e.continue())},r.onerror=function(o){return t("unable to locate logs earlier than "+e+"d.")}}();else{o.clear().onerror=function(e){return t(e.target.error)}}}},{key:"clean",value:function(){if(s.status!==i(s.__proto__||Object.getPrototypeOf(s),"STATUS",this).INITED)return s._pool.push(function(){return s.clean()});s.db.close();var e=window.indexedDB.deleteDatabase(s._database);e.onerror=function(e){return t(e.target.error)},e.onsuccess=function(t){delete s.status,delete s.db}}},{key:"_getTransactionStore",value:function(e){if(s.db){var o=s.db.transaction(["logs"],e||IDBTransaction.READ_WRITE||"readwrite");return o.onerror=function(e){return t(e.target.error)},o.objectStore("logs")}t("log database is not created or connections are closed, considering init it.")}},{key:"support",get:function(){return!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange)}}]),s}(p),y=function(o){function n(){var t;r(this,n);for(var e=arguments.length,o=Array(e),a=0;a<e;a++)o[a]=arguments[a];return u(this,(t=n.__proto__||Object.getPrototypeOf(n)).call.apply(t,[this].concat(o)))}return c(n,o),a(n,[{key:"_record",value:function(o,r,a){var i=window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[];i.push([Date.now(),this._namespace,o,r,a]);try{e(this._namespace,o,r,a),window.localStorage.setItem(n._database,JSON.stringify(i))}catch(e){t("error inserting record")}}}],[{key:"init",value:function(e){n.support||t("your platform does not support localstorage protocol."),n._database=e||"logline",window.localStorage.getItem(n._database)||window.localStorage.setItem(n._database,JSON.stringify([])),n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED}},{key:"get",value:function(t,e,o){var r,a=JSON.parse(window.localStorage.getItem(n._database));for(t=p.transTimeFormat(t),e=p.transTimeFormat(e),r=0;r<a.length;r++)t&&a[r][0]<t||e&&a[r][0]>e||(a[r]={time:a[r][0],namespace:a[r][1],level:a[r][2],descriptor:a[r][3],data:a[r][4]});o(a)}},{key:"keep",value:function(t){var e=t?(window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[]).filter(function(e){return e.time>=Date.now()-24*(t||2)*3600*1e3}):[];window.localStorage.setItem(n._database,JSON.stringify(e))}},{key:"clean",value:function(){delete n.status,window.localStorage.removeItem(n._database)}},{key:"support",get:function(){return"localStorage"in window}}]),n}(p),g=function(o){function n(){var t;r(this,n);for(var e=arguments.length,o=Array(e),a=0;a<e;a++)o[a]=arguments[a];return u(this,(t=n.__proto__||Object.getPrototypeOf(n)).call.apply(t,[this].concat(o)))}return c(n,o),a(n,[{key:"_record",value:function(o,r,a){var i=this;if(n.status!==p.STATUS.INITED)return n._pool.push(function(){return i._record(o,r,a)}),void(n.status!==p.STATUS.INITING&&n.init());try{e(this._namespace,o,r,a),n._db.transaction(function(t){t.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),i._namespace,o,r,void 0===a||""===a?"":JSON.stringify(a)||""],function(){},function(t,e){throw e.message})})}catch(e){t("error inserting record")}}}],[{key:"init",value:function(e){var o=this;if(n.support||t(new Error("your platform does not support websql protocol.")),n.status)return!1;n._pool=n._pool||new d,n._database=e||"logline",n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITING;try{n._db=window.openDatabase(n._database,"1.0","cats loves logs",5085593.6),n._db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",o).INITED,n._pool.consume()},function(){n.status=i(n.__proto__||Object.getPrototypeOf(n),"STATUS",o).FAILED})})}catch(e){t("unable to init log database.")}}},{key:"get",value:function(e,o,r){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return n._pool.push(function(){return n.get(e,o,r)});e=p.transTimeFormat(e),o=p.transTimeFormat(o);try{n._db.transaction(function(t){t.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(t,n){for(var a,i,c=[],u=n.rows.length;--u>=0;)if(i=n.rows.item(u),!(e&&i.time<e||o&&i.time>o)){a=JSON.parse(JSON.stringify(i));try{a.data=JSON.parse(a.data)}catch(t){}c.push(a)}r(c)},function(t,e){throw e.message})})}catch(e){t("unable to collect logs from database.")}}},{key:"keep",value:function(e){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return n._pool.push(function(){return n.keep(e)});try{n._db.transaction(function(t){e?t.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(e||2)*3600*1e3],function(){},function(t,e){throw e.message}):t.executeSql("DELETE FROM logs",[],function(){},function(t,e){throw e.message})})}catch(e){t("unable to clean logs from database.")}}},{key:"clean",value:function(){if(n.status!==i(n.__proto__||Object.getPrototypeOf(n),"STATUS",this).INITED)return void n._pool.push(function(){return n.clean()});try{n._db.transaction(function(t){t.executeSql("DROP TABLE logs",[],function(){delete n.status},function(t,e){throw e.message})})}catch(e){t("unable to clean log database.")}}},{key:"support",get:function(){return"openDatabase"in window}}]),n}(p),v=function(){function e(t){return r(this,e),e._checkProtocol(),new e._protocol(t)}return a(e,null,[{key:"_initProtocol",value:function(t){e._protocol=t,e._protocol.init(e._database||"logline")}},{key:"_checkProtocol",value:function(){if(!e._protocol){for(var t=Object.keys(e.PROTOCOL),o=void 0;o=e.PROTOCOL[t.shift()];)if(o.support)return void e._initProtocol(o);throw new Error(t.join(", ").toLowerCase()+" protocols are not supported on this platform")}}},{key:"get",value:function(t,o,n){Date.now();switch(e._checkProtocol(),arguments.length){case 1:n=t,t=void 0;break;case 2:n=o,o=void 0;break;case 3:}e._protocol.get(t,o,n)}},{key:"all",value:function(t){e.get(t)}},{key:"keep",value:function(t){return e._checkProtocol(),e._protocol.keep(t),this}},{key:"clean",value:function(){return e._checkProtocol(),e._protocol.clean(),this}},{key:"using",value:function(o,n){return-1===[_,y,g].indexOf(o)&&t("specialfied protocol "+(o?o+" ":"")+"is not available"),e._protocol?this:(e.database(n||e._database),e._initProtocol(o),this)}},{key:"database",value:function(t){e._database=t}}]),e}();return v.PROTOCOL={INDEXEDDB:_,LOCALSTORAGE:y,WEBSQL:g},v.INTERFACE=Object.freeze(p),v});
//# sourceMappingURL=logline.min.js.map
